@model CodeWithMena.PerfumeShop.PL.ViewModels.POS.POSCreateVm
@{
    ViewData["Title"] = "POS - New Sale";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script type="application/json" id="perfumes-data">
@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PerfumeOils.Select(p => new { p.Id, p.Name, p.ManufacturingCompany, p.SalePricePerGram }).ToList()))
</script>

<h1>Point of Sale</h1>
<div class="row">
    <div class="col-md-8">
        <div class="card mb-3">
            @* <div class="card-header">Add Perfume Item</div>
             <div class="card-body">
                <div class="row g-2 mb-2">
                    <div class="col-md-5 position-relative">
                        <label class="form-label">Perfume (type to search)</label>
                        <input type="text" id="perfumeSearch" class="form-control" placeholder="Type perfume name..." autocomplete="off" />
                        <input type="hidden" id="perfumeId" />
                        <div id="perfumeDropdown" class="list-group shadow border" style="display:none; max-height: 200px; overflow-y: auto; z-index: 1000; position: absolute; left: 0; right: 0; top: 100%;"></div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Bottle</label>
                        <select id="bottleId" class="form-select">
                            <option value="">-- Select --</option>
                            @foreach (var b in Model.Bottles)
                            {
                                <option value="@b.Id" data-size="@b.SizeMl" data-price="@b.SalePrice">@b.Name (@b.SizeMl ml)</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Oil (grams)</label>
                        <input type="number" id="perfumeOilGrams" class="form-control" step="0.01" min="0" value="0" placeholder="e.g. 12" title="Grams of perfume oil per unit" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Unit Price</label>
                        <input type="number" id="unitPrice" class="form-control" step="0.01" readonly />
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Qty</label>
                        <input type="number" id="qty" class="form-control" value="1" min="1" />
                    </div>
                </div>
                <div class="mt-2">
                    <button type="button" id="btnGetPrice" class="btn btn-outline-secondary">Get Price</button>
                    <button type="button" id="btnAdd" class="btn btn-primary">Add to Cart</button>
                </div>
            </div> *@
        </div>
        <div class="card mb-3">
            <div class="card-header">Add Custom Item (name + price + count)</div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Item Name</label>
                        <input type="text" id="manualName" class="form-control" placeholder="e.g. Gift wrap" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Unit Price (EGP)</label>
                        <input type="number" id="manualPrice" class="form-control" step="0.01" min="0" placeholder="0" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Qty</label>
                        <input type="number" id="manualQty" class="form-control" value="1" min="1" />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" id="btnAddManual" class="btn btn-outline-primary">Add</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Cart</div>
            <div class="card-body">
                <table class="table table-sm" id="cartTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Bottle / Type</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Line Total</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="cartBody"></tbody>
                </table>
                <p class="text-muted mb-0" id="cartEmpty">Cart is empty.</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">Checkout</div>
            <div class="card-body">
                <div class="mb-2">
                    <label class="form-label">Discount %</label>
                    <input type="number" id="discountPercent" class="form-control" step="0.01" min="0" max="100" placeholder="0" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Discount (EGP)</label>
                    <input type="number" id="discountAmount" class="form-control" step="0.01" min="0" placeholder="0" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Payment</label>
                    <input type="text" id="paymentMethod" class="form-control" placeholder="Cash/Card" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Notes</label>
                    <textarea id="notes" class="form-control" rows="2"></textarea>
                </div>
                <hr />
                <p><strong>Subtotal:</strong> <span id="subtotal">0.00</span> EGP</p>
                <p><strong>Total:</strong> <span id="total">0.00</span> EGP</p>
                <button type="button" id="btnCheckout" class="btn btn-success w-100" disabled>Complete Sale</button>
            </div>
        </div>
    </div>
</div>

@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{ var token = Antiforgery.GetAndStoreTokens(Context).RequestToken; }
<input type="hidden" id="requestVerificationToken" value="@token" />
<script>
    try { window.__perfumes = JSON.parse(document.getElementById('perfumes-data').textContent); } catch(e) { window.__perfumes = []; }
    window.__getUnitPriceUrl = '@(Url.Action("GetUnitPrice", "POS"))';
    window.__createSaleUrl = '@(Url.Action("Create", "POS"))';
    window.__invoiceUrl = '@(Url.Action("Invoice", "POS"))';
</script>

@section Scripts {
<script>
(function() {
    const cart = [];
    const perfumes = window.__perfumes || [];
    const perfumeSearch = document.getElementById('perfumeSearch');
    const perfumeIdInput = document.getElementById('perfumeId');
    const perfumeDropdown = document.getElementById('perfumeDropdown');
    const bottleSelect = document.getElementById('bottleId');
    const perfumeOilGrams = document.getElementById('perfumeOilGrams');
    const unitPriceInput = document.getElementById('unitPrice');
    const qtyInput = document.getElementById('qty');
    const btnGetPrice = document.getElementById('btnGetPrice');
    const btnAdd = document.getElementById('btnAdd');
    const cartBody = document.getElementById('cartBody');
    const cartEmpty = document.getElementById('cartEmpty');
    const cartTable = document.getElementById('cartTable');
    const discountPercent = document.getElementById('discountPercent');
    const discountAmount = document.getElementById('discountAmount');
    const subtotalEl = document.getElementById('subtotal');
    const totalEl = document.getElementById('total');
    const btnCheckout = document.getElementById('btnCheckout');
    const manualName = document.getElementById('manualName');
    const manualPrice = document.getElementById('manualPrice');
    const manualQty = document.getElementById('manualQty');
    const btnAddManual = document.getElementById('btnAddManual');

    function getToken() { return document.getElementById('requestVerificationToken').value; }

    function updateTotals() {
        let st = cart.reduce((s, i) => s + i.lineTotal, 0);
        let discount = 0;
        const pct = parseFloat(discountPercent.value) || 0;
        const amt = parseFloat(discountAmount.value) || 0;
        if (pct > 0) discount = st * pct / 100;
        else if (amt > 0) discount = Math.min(amt, st);
        const total = Math.max(0, st - discount);
        subtotalEl.textContent = st.toFixed(2);
        totalEl.textContent = total.toFixed(2);
        btnCheckout.disabled = cart.length === 0;
    }

    function renderCart() {
        cartBody.innerHTML = cart.map((item, idx) => {
            const bottleCol = item.isManual ? '—' : (item.bottleSize ? item.bottleSize + ' ml' : '—');
            return '<tr><td>' + item.nameSnapshot + '</td><td>' + bottleCol + '</td><td>' + item.quantity + '</td><td>' + item.unitPrice.toFixed(2) + '</td><td>' + item.lineTotal.toFixed(2) + '</td><td><button type="button" class="btn btn-sm btn-outline-danger remove" data-idx="' + idx + '">Remove</button></td></tr>';
        }).join('');
        cartEmpty.style.display = cart.length ? 'none' : 'block';
        cartTable.style.display = cart.length ? 'table' : 'none';
        document.querySelectorAll('.remove').forEach(b => {
            b.onclick = function() {
                cart.splice(parseInt(this.getAttribute('data-idx')), 1);
                renderCart();
                updateTotals();
            };
        });
        updateTotals();
    }

    perfumeSearch.addEventListener('focus', function() {
        const q = this.value.trim().toLowerCase();
        const list = perfumes.filter(p => p.Name.toLowerCase().includes(q));
        perfumeDropdown.innerHTML = list.slice(0, 20).map(p =>
            '<a href="#" class="list-group-item list-group-item-action" data-id="' + p.Id + '" data-name="' + (p.Name || '').replace(/"/g, '&quot;') + '" data-mfg="' + (p.ManufacturingCompany || '').replace(/"/g, '&quot;') + '">' + p.Name + '</a>'
        ).join('');
        perfumeDropdown.style.display = list.length ? 'block' : 'none';
    });
    perfumeSearch.addEventListener('input', function() {
        const q = this.value.trim().toLowerCase();
        const list = perfumes.filter(p => p.Name.toLowerCase().includes(q));
        perfumeDropdown.innerHTML = list.slice(0, 20).map(p =>
            '<a href="#" class="list-group-item list-group-item-action" data-id="' + p.Id + '" data-name="' + (p.Name || '').replace(/"/g, '&quot;') + '" data-mfg="' + (p.ManufacturingCompany || '').replace(/"/g, '&quot;') + '">' + p.Name + '</a>'
        ).join('');
        perfumeDropdown.style.display = list.length ? 'block' : 'none';
        perfumeDropdown.querySelectorAll('a').forEach(a => {
            a.addEventListener('click', function(e) {
                e.preventDefault();
                perfumeIdInput.value = this.getAttribute('data-id');
                perfumeSearch.value = this.getAttribute('data-name');
                perfumeDropdown.style.display = 'none';
                if (bottleSelect.value) btnGetPrice.click();
            });
        });
    });
    document.addEventListener('click', function(e) {
        if (!perfumeSearch.contains(e.target) && !perfumeDropdown.contains(e.target))
            perfumeDropdown.style.display = 'none';
    });

    btnGetPrice.addEventListener('click', async function() {
        const bid = (bottleSelect.value || '').trim();
        if (!bid) { alert('Please select a bottle first.'); return; }
        const pid = (perfumeIdInput.value || '').trim() || null;
        const grams = parseFloat(perfumeOilGrams.value) || 0;
        var basePath = (window.__getUnitPriceUrl || '').trim();
        if (basePath && basePath.indexOf('/') !== 0) basePath = '/' + basePath;
        var url = basePath + '?bottleId=' + encodeURIComponent(bid) + '&grams=' + encodeURIComponent(grams);
        if (pid) url += '&perfumeOilId=' + encodeURIComponent(pid);
        try {
            const r = await fetch(url, { method: 'GET', credentials: 'same-origin' });
            if (r.ok) {
                const price = await r.json();
                unitPriceInput.value = (typeof price === 'number' ? price : parseFloat(price)).toFixed(2);
            } else {
                const text = await r.text();
                unitPriceInput.value = '';
                alert('Could not get price (server ' + r.status + '). Check that Alcohol Price is set in Settings. ' + (text ? text.substring(0, 100) : ''));
            }
        } catch (e) {
            console.error(e);
            unitPriceInput.value = '';
            alert('Could not get price. Check the page URL and try again. Error: ' + (e.message || e));
        }
    });

    bottleSelect.addEventListener('change', function() {
        if (perfumeIdInput.value) btnGetPrice.click();
    });
    perfumeOilGrams.addEventListener('input', function() {
        if (bottleSelect.value) btnGetPrice.click();
    });

    btnAdd.addEventListener('click', function() {
        const bid = (bottleSelect.value || '').trim();
        const up = parseFloat(unitPriceInput.value) || 0;
        const qty = parseInt(qtyInput.value, 10) || 1;
        if (!bid) { alert('Please select a bottle.'); return; }
        if (up <= 0) { alert('Please click "Get Price" first to calculate the unit price.'); return; }
        const pid = perfumeIdInput.value || null;
        const name = perfumeSearch.value.trim() || 'Perfume';
        const mfg = perfumes.find(p => p.Id === pid)?.ManufacturingCompany || '';
        const bottleOpt = bottleSelect.selectedOptions[0];
        const size = bottleOpt ? bottleOpt.getAttribute('data-size') || '' : '';
        const grams = parseFloat(perfumeOilGrams.value) || 0;
        cart.push({
            perfumeOilId: pid || null,
            bottleId: bid,
            perfumeOilGrams: grams,
            nameSnapshot: name,
            manufacturingCompanySnapshot: mfg || null,
            quantity: qty,
            unitPrice: up,
            lineTotal: up * qty,
            bottleSize: size,
            isMixed: false,
            isManual: false,
            mixedPerfumeItems: null
        });
        renderCart();
    });

    btnAddManual.addEventListener('click', function() {
        const name = manualName.value.trim();
        const price = parseFloat(manualPrice.value) || 0;
        const qty = parseInt(manualQty.value) || 1;
        if (!name) { alert('Enter item name'); return; }
        if (price < 0) { alert('Price must be >= 0'); return; }
        cart.push({
            perfumeOilId: null,
            bottleId: null,
            perfumeOilGrams: null,
            nameSnapshot: name,
            manufacturingCompanySnapshot: null,
            quantity: qty,
            unitPrice: price,
            lineTotal: price * qty,
            bottleSize: '',
            isMixed: false,
            isManual: true,
            mixedPerfumeItems: null
        });
        renderCart();
        manualName.value = '';
        manualPrice.value = '';
        manualQty.value = '1';
    });

    discountPercent.addEventListener('input', updateTotals);
    discountAmount.addEventListener('input', updateTotals);

    btnCheckout.addEventListener('click', async function() {
        if (cart.length === 0) return;
        const payload = {
            discountPercent: parseFloat(discountPercent.value) || null,
            discountAmount: parseFloat(discountAmount.value) || null,
            paymentMethod: document.getElementById('paymentMethod').value || null,
            notes: document.getElementById('notes').value || null,
            items: cart.map(i => ({
                perfumeOilId: i.perfumeOilId,
                bottleId: i.bottleId,
                perfumeOilGrams: i.perfumeOilGrams,
                nameSnapshot: i.nameSnapshot,
                manufacturingCompanySnapshot: i.manufacturingCompanySnapshot,
                quantity: i.quantity,
                unitPrice: i.unitPrice,
                isMixed: i.isMixed,
                isManual: i.isManual,
                mixedPerfumeItems: i.mixedPerfumeItems
            }))
        };
        try {
            const r = await fetch(window.__createSaleUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getToken()
                },
                credentials: 'same-origin',
                body: JSON.stringify(payload)
            });
            if (r.ok) {
                const data = await r.json();
                const base = (window.__invoiceUrl || '').replace(/\/$/, '');
                window.location.href = base + '/' + data.saleId;
            } else {
                const text = await r.text();
                alert('Error: ' + (text || r.status));
            }
        } catch (e) { alert('Error: ' + e.message); }
    });
})();
</script>
}
